<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Webcam & Mic Stream</title>
    <style>
        /* Essential for full viewport coverage */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent any scrollbars */
            background-color: #000; /* Fallback background color */
        }

        #videoElement {
            /* Position video relative to the viewport */
            position: fixed;
            top: 0;
            left: 0;
            /* Make it cover 100% of the viewport */
            width: 100vw;
            height: 100vh;
            object-fit: cover; /* Scale and crop to cover the area, maintaining aspect ratio */
            z-index: 1; /* Place it in the background */
            background-color: #666; /* Placeholder background before stream starts */
        }

        /* Container for the button - placed *above* the video */
        #controlsContainer { /* Renamed from 'container' for clarity of purpose */
            position: relative; /* Establishes stacking context */
            width: 100%;
            height: 100%;
            display: flex; /* Use flexbox to center the button */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            z-index: 10; /* Ensure controls are above the video */
        }

        #micToggleButton {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent background for button */
            color: white;
            border: 2px solid white;
            cursor: pointer;
            border-radius: 8px;
            /* Display property will be controlled by JavaScript */
        }

        /* Hide the audio element controls visually, as it's just for passthrough */
        #audioOutput {
            display: none;
        }
    </style>
</head>
<body>
    <video autoplay="true" id="videoElement"></video>

    <div id="controlsContainer">
        <button id="micToggleButton">Start Mic</button>
        
        <audio id="audioOutput" autoplay></audio>
    </div>

    <script>
        const videoElement = document.getElementById('videoElement');
        let micStream = null; // Renamed for clarity to distinguish from video stream
        const micToggleButton = document.getElementById('micToggleButton');
        const audioOutput = document.getElementById('audioOutput');

        // --- 1. Webcam Video Stream Initialization ---
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    videoElement.srcObject = stream;
                    console.log('Webcam video started.');
                })
                .catch(function (error) {
                    console.error('Error accessing webcam for video:', error);
                    alert('Could not access webcam for video: ' + error.message);
                });
        } else {
            console.error('getUserMedia is not supported for video in this browser.');
            alert('Your browser does not support webcam access for video.');
        }

        // --- 2. Microphone Toggle Logic ---
        micToggleButton.addEventListener('click', async () => {
            if (micStream) {
                // If microphone is currently active, stop it
                micStream.getAudioTracks().forEach(track => track.stop());
                micStream = null;
                audioOutput.srcObject = null; // Disconnect audio output
                micToggleButton.textContent = 'Start Mic';
                micToggleButton.style.display = 'block'; // Make button visible
                console.log('Microphone stopped.');
            } else {
                // If microphone is off, start it
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            autoGainControl: false,
                            echoCancellation: false,
                            noiseSuppression: false
                        },
                        video: false // We still only need audio for this part
                    });

                    micStream = stream;
                    audioOutput.srcObject = stream;
                    micToggleButton.textContent = 'Stop Mic';
                    micToggleButton.style.display = 'none'; // Make button go away
                    console.log('Microphone started, streaming to speakers.');

                    // Listen for when the microphone stream becomes inactive unexpectedly
                    stream.oninactive = () => {
                        console.log('Microphone stream became inactive unexpectedly.');
                        if (micStream) {
                            micStream.getAudioTracks().forEach(track => track.stop());
                            micStream = null;
                            audioOutput.srcObject = null;
                            micToggleButton.textContent = 'Start Mic';
                            micToggleButton.style.display = 'block'; // Make button visible again
                        }
                    };

                } catch (err) {
                    // Handle errors if microphone access is denied or fails
                    console.error('Error accessing microphone:', err);
                    alert('Could not access microphone: ' + err.message + '\nPlease ensure microphone access is allowed.');
                    micToggleButton.style.display = 'block'; // Ensure button reappears on error
                }
            }
        });
    </script>
</body>
</html>
