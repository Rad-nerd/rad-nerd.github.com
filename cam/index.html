<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Webcam Stream</title>
    <style>
        #videoElement {
            width: 100%;
            background-color: #666;
        }
    </style>
</head>
<body>
    <div id="container">
        <button id="micToggleButton">Start Mic</button>
    <audio id="audioOutput" autoplay></audio>
    <video autoplay="true" id="videoElement"></video>
    </div>
    <script>const video = document.getElementById('videoElement');

if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
            video.srcObject = stream;
        })
        .catch(function (error) {
            console.error('Error accessing webcam:', error);
        });
} else {
    console.error('getUserMedia is not supported in this browser.');
}

</script>

<script>
        let currentStream = null;
        const micToggleButton = document.getElementById('micToggleButton');
        const audioOutput = document.getElementById('audioOutput');

        micToggleButton.addEventListener('click', async () => {
            if (currentStream) {
                // If microphone is currently active, stop it
                currentStream.getAudioTracks().forEach(track => track.stop());
                currentStream = null;
                audioOutput.srcObject = null; // Disconnect audio output
                micToggleButton.textContent = 'Start Mic';
                console.log('Microphone stopped.');
            } else {
                // If microphone is off, start it
                try {
                    // --- MODIFICATION HERE: Detailed Audio Constraints ---
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            autoGainControl: false,
                            echoCancellation: false,
                            noiseSuppression: false
                        },
                        video: false // We still don't need video
                    });
                    // --- END MODIFICATION ---

                    currentStream = stream;
                    audioOutput.srcObject = stream;
                    micToggleButton.textContent = 'Stop Mic';
                    console.log('Microphone started, streaming to speakers.');

                    stream.oninactive = () => {
                        console.log('Microphone stream became inactive unexpectedly.');
                        if (currentStream) {
                            currentStream.getAudioTracks().forEach(track => track.stop());
                            currentStream = null;
                            audioOutput.srcObject = null;
                            micToggleButton.textContent = 'Start Mic';
                        }
                    };

                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    alert('Could not access microphone: ' + err.message + '\nPlease ensure microphone access is allowed.');
                    micToggleButton.textContent = 'Start Mic';
                }
            }
        });
    </script>
</body>
</html>
