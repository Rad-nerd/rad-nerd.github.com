<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Webcam Stream</title>
    <style>
        #videoElement {
            width: 100%;
            background-color: #666;
        }
    </style>
</head>
<body>
    <div id="container">
        <button id="startButton">Start Mic</button>
    <button id="stopButton" disabled>Stop Mic</button>
    <div id="audioOutputContainer">
    </div>

    <script>
        let currentStream = null;
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusDisplay = document.getElementById('status');
        const audioOutputContainer = document.getElementById('audioOutputContainer');

        // Function to handle successful stream acquisition
        function handleSuccess(stream) {
            statusDisplay.textContent = "Microphone connected! You should hear yourself.";
            
            // Stop any existing stream tracks
            if (currentStream) {
                currentStream.getAudioTracks().forEach(track => track.stop());
            }
            currentStream = stream; // Store the new stream

            // Create or get the audio element for playback
            let audio = document.getElementById('realtime-audio');
            if (!audio) {
                audio = document.createElement('audio');
                audio.id = 'realtime-audio';
                audio.controls = true; // Show controls (optional, but useful for debugging)
                audio.autoplay = true; // Crucial for immediate playback
                audioOutputContainer.appendChild(audio); // Append to a container
            } else {
                audio.autoplay = true; // Ensure autoplay is active
            }

            // Connect the live microphone stream directly to the audio element
            audio.srcObject = stream;

            // Handle stream ending (e.g., if user revokes permission or track is stopped)
            stream.oninactive = function() {
                console.log('Stream ended');
                statusDisplay.textContent = "Microphone stream ended.";
                startButton.disabled = false;
                stopButton.disabled = true;
                if (audio && audio.parentNode) {
                    // audio.parentNode.removeChild(audio); // Optionally remove the audio element
                }
            };

            startButton.disabled = true;
            stopButton.disabled = false;
        }

        // Function to handle errors during stream acquisition
        function handleError(error) {
            console.error('Error accessing microphone:', error);
            statusDisplay.textContent = `Error: ${error.message}. Please ensure microphone access is allowed.`;
            startButton.disabled = false;
            stopButton.disabled = true;
            // alert('Error: ' + error.message + '\nPlease ensure microphone access is allowed.');
        }

        // Event listener for the Start button
        startButton.addEventListener('click', () => {
            statusDisplay.textContent = "Requesting microphone access...";
            // Define constraints for getUserMedia (we only need audio)
            const constraints = {
                audio: true,
                video: false
            };
            
            // Request microphone access
            navigator.mediaDevices.getUserMedia(constraints)
                .then(handleSuccess) // If successful, pass stream to handleSuccess
                .catch(handleError); // If error, pass error to handleError
        });

        // Event listener for the Stop button
        stopButton.addEventListener('click', () => {
            if (currentStream) {
                // Stop all tracks in the current stream
                currentStream.getAudioTracks().forEach(track => track.stop());
                currentStream = null;
                if (document.getElementById('realtime-audio')) {
                    document.getElementById('realtime-audio').remove(); // Remove the audio element
                }
                statusDisplay.textContent = "Microphone stopped.";
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        });
    </script>        <video autoplay="true" id="videoElement"></video>
    </div>
    <script>const video = document.getElementById('videoElement');

if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
            video.srcObject = stream;
        })
        .catch(function (error) {
            console.error('Error accessing webcam:', error);
        });
} else {
    console.error('getUserMedia is not supported in this browser.');
}
</script>
</body>
</html>
